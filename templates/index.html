$def with (data)

$var title: GraPHOtti.

<!-- 		<nav class="navbar navbar-default">
		  	<div class="container-fluid">
	    		<div class="navbar-header">
	      			<div class="navbar-brand">
	        			GraPHOtti @ WestEndLights

	      			</div>

	    		</div>
	  		</div>
		</nav>
 -->	
		<ul class="nav nav-tabs">
		  <li role="presentation" class="active"><a href="#draw">Doodle</a></li>
		  <li role="presentation"><a href="/graphotti/about">About</a></li>
		  <li role="presentation"><a href="#share">Share</a></li>
		</ul>

		<div class="jumbotron jumbotron-fluid">
		  	<h1><small>Graffiti on your phone</small></h1>

		  	<p><small>
		  		A collaborative, creative "graffiti snow globe".
		    	<b>Draw</b> on our window! <b>Turn</b> and <b>shake</b> your phone for a wintery snow storm.
		    </small>
		    </p>
		</div>

		<style>
			canvas[resize] {
 			   width: 100%;
    			height: 100%;
			}
		</style>
 		<div class="container">
			<div class="row">
				<div class="panel panel-default">
				  	<div class="panel-heading">
						<a name="draw" ></a>
				    	<h3 class="panel-title">Draw here <small>(don't forget to turn and shack your phone, too!)</small></h3>
				  	</div>
				  	<div class="panel-body text-center">
						<a name="draw"></a>
						<button type="button" class="btn btn-success btn-block" onclick="fullscreen_canvas();">Go fullscreen!</button>

					    <div id="canvascontainer" style="text-align:center">
					    	<div style="max-width: 100vmin; max-height: 100vmin">
								<canvas id="myCanvas" border="1" keepalive="true" width="600" height="600" resize="true" style="border:2px solid #555555;background: black;">
								</canvas>
							</div>
						</div>
						<a type="button" class="btn btn-warning btn-block" href="/graphotti/image_store"><h3>View current window</h3> <img src="/graphotti/image_store" width="50px" /></a>

					</div>				
				</div>
			</div>
			<div class="row">
				<div class="panel panel-default">
				  	<div class="panel-heading">
						<a name="draw" ></a>
				    	<h3 class="panel-title">Canny</h3>
				  	</div>
				  	<div class="panel-body text-center">
						<a name="canny"></a>
						<video hidden id="video" width="600" height="600" autoplay></video>
						<canvas hidden id="canvas" width="600" height="600"></canvas>
					    <div id="canvascontainer" style="text-align:center">
					    	<div style="max-width: 100vmin; max-height: 100vmin">
								<canvas hidden="true" id="canvasOutput" keepalive="true" width="600" height="600" resize="true" style="border:2px solid #555555;background: black;">
								</canvas>
								<h3 id="canvasOutput_placeholder">
									If your camera is working, the video will soon show here. It can be a few more seconds...
								</h3>
							</div>
						</div>
						<input id="torch"   type="checkbox" >Torch</input>
						<button type="button" class="btn" id="change_cam">Change Camera</button>
						<button type="button" id="snap"  class="btn" onclick="snap_photo();">Snap Photo</button>
					</div>				
				</div>
			</div>
			<div class="row">
				<div class="panel panel-default">
				  	<div class="panel-heading">
				    	<h3 class="panel-title">Share</h3>
				    	Share on Twitter and follow posts from others at <a href="https://twitter.com/graPH0tti">https://twitter.com/graPH0tti</a>.
				  	</div>
				  	<div class="panel-body">
						<a name="share"></a>
						<button type="button" class="btn btn-primary btn-block" onclick="tweet();">Tweet current doodle on @graPH0tti</button>
					</div>
<!-- 				  	<div class="panel-body">


						<div class="fb-like" data-href="https://lcas.lincoln.ac.uk/graphotti/about" data-layout="standard" data-action="like" data-show-faces="false" data-share="true"></div>

				  		<a href="https://twitter.com/graPH0tti" class="twitter-follow-button" data-show-count="false" data-size="large" data-dnt="true">Follow @graPH0tti</a>
						<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

						<a href="https://twitter.com/intent/tweet?screen_name=graPH0tti&text=%23westendlights" class="twitter-mention-button" data-size="large" data-related="graPH0tti,WestEndLights" data-dnt="true">Tweet to @graPH0tti</a>
						<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

					</div>
					<div class="panel-body">
						<a class="twitter-timeline" data-dnt="true" href="https://twitter.com/graPH0tti" data-widget-id="664420268740354048">Tweets by @graPH0tti</a>
						<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>				

					</div>
-->
				</div>
 

			</div>
<!-- 
			<div class="row">
				<div class="panel panel-default">
					<div class="panel-heading">
						<h3 class="panel-title">Where you are</h3>
					</div>
					<div class="panel-body">
						<div id="mapholder"><H3>GraPHOtti needs to know your location to make sure you are close to our Window before you are allowed to draw.</H3></div>
					</div>
				</div>
			</div>
 -->
		</div>


	<script async type="text/javascript"  src="/static/js/opencv.js" onload="register_cv();"></script>


	<script type="text/javascript">


		function fullscreen_canvas() {
            var el = document.getElementById('canvascontainer');
 
            if(el.webkitRequestFullScreen) {
               el.webkitRequestFullScreen();
            }
            else {
              el.mozRequestFullScreen();
            }            
		}


		function send_path(path) {
			$$.post('#', path).fail(function() {
    			alert( "you are not allowed to draw from where you are!" );
  			});
		}

		function tweet() {
			$$.post('tweet', {});
		}

		function send_acc(a, t, gravity_angle) {
			$$.post(location.pathname + '/acc', {
				'acc_abs': a,
				'acc_time': t,
				'gravity_angle': gravity_angle
			});
		}


		function init_imu() {
			acc_abs = 0.0;
			acc_time = 0.0;
			count = 0;
			last_ts = Date.now();
			if (window.DeviceMotionEvent != undefined) {
				window.ondevicemotion = function(e) {
					if (event.accelerationIncludingGravity.x != null) {
						var ab = Math.sqrt(
											event.acceleration.x * event.acceleration.x +
											event.acceleration.y * event.acceleration.y +
											event.acceleration.z * event.acceleration.z
										) ;
						var gravity_angle = Math.atan2(event.accelerationIncludingGravity.x, event.accelerationIncludingGravity.y);
						// accumulated acceleration
						acc_abs = acc_abs + ab
						acc_time = acc_time + event.interval;
						count = count + 1;
						if (Date.now() > last_ts+500) {
							acc_abs = acc_abs / count;
							//if (acc_abs > 1.0) {
								console.log(acc_abs + ' m/s2 ');
								send_acc(acc_abs, acc_time, gravity_angle);
							//}
							acc_abs = 0.0;
							count = 0;
							last_ts = Date.now();
							acc_time = 0;
						}
						

					}
				} 
			}
		}

		function snap_photo() {
			let canvasOutput = document.getElementById("canvasOutput"); 
			let base64Str = canvasOutput.toDataURL("image/png");
			//base64Str = base64Str.replace('data:image/jpg;base64,','');
			console.log(base64Str);
			$$.post(location.pathname + '/photo', {
				img: base64Str
			});
			var video = document.getElementById('video');
			video.pause();
			for (p in paths) {
				paths[p].remove();
				paths.splice(p,1);
			}

		}

		function register_cv() {
			cv['onRuntimeInitialized']=()=>{
				console.log('opencv ready');
				if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
					console.log('initialise video capture');
					init_video();
				} else {
					console.log('no media device API available');
				}
			}
		}

		function init_video() {
			var video = document.getElementById('video');
			//console.log(navigator.mediaDevices.getSupportedConstraints());
			// Not adding `{ audio: true }` since we only want video now
			navigator.mediaDevices.getUserMedia({
					video: {
						facingMode: { ideal: 'environment'},
						frameRate: { ideal: 5},
						aspectRatio: { exact: 1},
						width: {max: 600},
						height: {max: 600}
					},
					audio: false
			}).then(function(stream) {
				const track = stream.getVideoTracks()[0];
				let track_settings = track.getSettings();
				let width = track_settings.width;
				//video.width=width;
				let height = track_settings.height;
				let ratio = track_settings.aspectRatio;
				//video.height=height;
				console.log(width, height);
				//Create image capture object and get camera capabilities
				const imageCapture = new ImageCapture(track)
				const photoCapabilities = imageCapture.getPhotoCapabilities().then(() => {
					//let there be light!
					const btn = document.querySelector('#torch');

					btn.addEventListener('click', function(){
						track.applyConstraints({
							advanced: [{torch: btn.checked}]
						});
					});
				});
				video.srcObject = stream;
				
				// start the video
				//video.play();

				video.onplaying = function () {
					console.log('playing');
					let canvasFrame = document.getElementById("canvas"); // canvasFrame is the id of <canvas>
					let canvasOutput = document.getElementById("canvasOutput"); 
					canvasOutput.onclick = function () {
						if (video.paused) {
							video.play();
						} else {
							video.pause();
						}

					};
					let context = canvasFrame.getContext("2d");

					//let ratio = width / height;
					let mat_width = canvasOutput.width; //canvasFrame.width;
					let mat_height = canvasOutput.height; //canvasFrame.width / ratio;
					let mat_ratio_height = mat_width / ratio;

					console.log(mat_width / ratio, mat_width, ratio);
					const FPS = 5;
					function processVideo() {
						let begin = Date.now();
						if (!video.paused) {
							let dst = new cv.Mat(mat_height, mat_width, cv.CV_8UC1);
							//let dst2 = new cv.Mat();
							let src = new cv.Mat(mat_height, mat_width, cv.CV_8UC4);
							//let src2 = new cv.Mat();
							context.drawImage(video, 0, 0, mat_width, mat_ratio_height);
							src.data.set(context.getImageData(
								0, 0, 
								mat_width, mat_ratio_height).data);
							//cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);
							cv.Canny(src, dst, 40, 120, 3, false);
							//console.log(dst);
							//cv.bitwise_or(src, src, dst2, dst);
							src.delete();
							//dst.delete();

							//cv.bitwise_not(dst, dst);
							cv.imshow("canvasOutput", dst); // canvasOutput is the id of another <canvas>;
							dst.delete();
						}
						let delay = 1000/FPS - (Date.now() - begin);
						setTimeout(processVideo, delay);
					}
					// schedule first one.
					canvasOutput.hidden = false;
					document.getElementById("canvasOutput_placeholder").hidden = true; 
					setTimeout(processVideo, 0);
				};

			}).catch(function(err) {
				console.log(err);
			});;	
				

		}

		window.onload = function() {

			init_imu();
			init_video();

			//getLocation();


			// Get a reference to the canvas object
			var canvas = document.getElementById('myCanvas');
			// Create an empty project and a view for the canvas:
			paper.setup(canvas);



			with (paper) {
    		    maximise(view, "myCanvas");
				var background = new paper.Layer();
				var secondLayer = new paper.Layer();
				secondLayer.activate();

				// Create a simple drawing tool:
				var tool = new Tool();
				var path;

				// geo_wait_text = new PointText(new Point(20, 20));
				// geo_wait_text.justification = 'left';
				// geo_wait_text.fillColor = 'red';
				// geo_wait_text.fontSize = 24;
				// geo_wait_text.content = '';
				geo_wait_text = null;
				latitude = 52;
				longitude = 0;



				// Define a mousedown and mousedrag handler
				tool.onMouseDown = function(event) {
					secondLayer.activate();
					path = new Path();
					color = [	Math.random()*0.5 + 0.5,
								Math.random()*0.5 + 0.5,
								Math.random()*0.5 + 0.5, 1]
					path.strokeColor = color;
					path.strokeColor.saturation = 255.0;
					path.strokeWidth = 5*zoom,
					p = event.point;
					// p.x /= pixel_ratio;
					// p.y /= pixel_ratio;
					path.add(p);
				}

				tool.onMouseDrag = function(event) {
					secondLayer.activate();
					p = event.point;
					// p.x /= pixel_ratio;
					// p.y /= pixel_ratio;
					path.add(p);
				}

				tool.onMouseUp = function(event) {
					secondLayer.activate();
					var data = {};
					data['path'] = path.exportJSON();
					data['zoom'] = zoom;
					data['latitude'] = latitude;
					data['longitude'] = longitude;
					data['pixel_ratio'] = pixel_ratio;
					paths.push(path);
					//path.remove();
					send_path(data);
				}

			    view.onFrame = function(event) {
					// On each frame, rotate the path by 3 degrees:

					for (p in paths) {
						//console.log(paths[p].strokeColor);
						t = paths[p].strokeColor.alpha;
						t = t - $config.client_decay;

						if (t <= 0.0) {
							paths[p].remove();
							paths.splice(p,1);
						} else {
							paths[p].strokeColor.alpha = t;
						}
						
					}
					
				}

			    if (document.addEventListener)
			    {
			        document.addEventListener('webkitfullscreenchange', handle_fullscreen, false);
			        document.addEventListener('mozfullscreenchange', handle_fullscreen, false);
			        document.addEventListener('fullscreenchange', handle_fullscreen, false);
			        document.addEventListener('MSFullscreenChange', handle_fullscreen, false);
			    }
				maximise(view, "myCanvas");		

			var photo_source = new EventSource("photo");
			photo_source.onmessage = function(event) {
				var d = JSON.parse(event.data);
				console.log('photo received');
				//if (view.photo) 
					//view.photo.remove();
				background.activate();
				//let canvasOutput = document.getElementById("canvasOutput"); 
				//canvasOutput.src = d['img']
				view.photo = new Raster(d['img']);
				view.photo.position = view.center;
				view.photo.scale(zoom);
				for (p in paths) {
					paths[p].remove();
					paths.splice(p,1);
				}

			}


			}
		}
</script>
